pipeline {
    agent any

    environment {
        AWS_CRED        = 'aws_jr10_wanda'
        S3BucketName    = 'jenkins.land-tasker-dev.net'
    }

    stages {
        stage('Build') {
            steps {
                withCredentials([string(credentialsId: 'JenkinsPasswd', variable: 'PASSWORD')]) {
                    sh "echo \$PASSWORD | sudo -S apt install -y nodejs"
                    sh 'npm install' // Install dependencies
                    sh 'npm run build' // Run npm build command
                }
            }
        }
        
        stage('Check S3 Bucket') {
            steps {
                withAWS(credentials: AWS_CRED, region: 'ap-southeast-2') {
                    script {
                        def filesToUpload = "out/*"

                        def bucketExists = sh(script: "aws s3 ls s3://$S3BucketName", returnStatus: true) == 0

                        if (bucketExists) {
                            stage('Upload Files') {
                                steps {
                                    sh "aws s3 cp ${filesToUpload} s3://$S3BucketName/ --recursive"
                                }
                            }
                        } 
                    }
                }
            }
        }
    }
}
