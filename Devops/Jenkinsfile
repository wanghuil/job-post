pipeline {
    agent any

    environment {
        AWS_CRED        = 'aws_jr10_wanda' 
        S3BucketName    = 'jenkins.land-tasker-dev.net' 
    }

    stages {
        stage('Check S3 Bucket') {
            steps {
                withAWS(credentials: AWS_CRED, region: 'ap-southeast-2') {
                    script {
                        def filesToUpload = "out/*"

                        def bucketExists = sh(script: "aws s3 ls s3://$S3BucketName", returnStatus: true) == 0

                        if (bucketExists) {
                            stage('Upload Files') {
                                steps {
                                    sh "aws s3 cp ${filesToUpload} s3://$S3BucketName/ --recursive"
                                }
                            }
                        } else {
                            stage('Create S3 Bucket') {
                                steps {
                                    sh "aws s3 mb s3://$S3BucketName"
                                }
                            }

                            stage('Upload Files') {
                                steps {
                                    sh "aws s3 cp ${filesToUpload} s3://$S3BucketName/ --recursive"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
